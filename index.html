<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan CMI â€” Dashboard Militar</title>
  <meta name="theme-color" content="#63744c" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- ðŸ” Pantalla de inicio de sesiÃ³n -->
<div id="loginScreen" style="
  position:fixed;inset:0;
  background:linear-gradient(135deg,#1c1f1b,#2b2f2a);
  display:flex;align-items:center;justify-content:center;
  z-index:9999;">
  <div style="
    background:#2b2f2a;
    padding:24px;border-radius:12px;
    width:300px;text-align:center;
    border:1px solid #41463e;
    box-shadow:0 3px 8px rgba(0,0,0,0.4);">
    <h2 style="color:#b89f5d;margin-bottom:12px;">ðŸ”’ Acceso Plan CMI</h2>
    <input id="passInput" type="password" placeholder="ContraseÃ±a" 
      style="width:100%;padding:8px;margin:8px 0;
      border-radius:6px;border:1px solid #41463e;
      background:#20231f;color:#e9e9e3;font-size:1rem;">
    <button id="loginBtn" class="btn" style="width:100%;">Entrar</button>
    <p id="msg" style="color:#f2c94c;font-size:0.9rem;margin-top:8px;"></p>
    <p style="font-size:0.8rem;color:#a0a79a;margin-top:10px;">
      * Solo tÃº puedes acceder a tu informaciÃ³n.
    </p>
  </div>
</div>

<script>
async function hash(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

const loginScreen = document.getElementById('loginScreen');
const stored = localStorage.getItem('cmi_pass');

document.getElementById('loginBtn').onclick = async () => {
  const input = document.getElementById('passInput').value.trim();
  const msg = document.getElementById('msg');
  if (!input) return;

  const hashVal = await hash(input);
  
  // Primera vez: crear contraseÃ±a
  if (!stored) {
    localStorage.setItem('cmi_pass', hashVal);
    msg.style.color = '#8ba870';
    msg.textContent = 'âœ… ContraseÃ±a creada. Bienvenido.';
    setTimeout(() => loginScreen.remove(), 600);
  } 
  // Validar
  else if (hashVal === stored) {
    msg.style.color = '#8ba870';
    msg.textContent = 'âœ… Acceso concedido';
    setTimeout(() => loginScreen.remove(), 600);
  } 
  // Error
  else {
    msg.style.color = '#d97777';
    msg.textContent = 'ContraseÃ±a incorrecta';
  }
};
</script>

  <header>
    <h1>Plan Integral CMI â€” FÃ­sico, AcadÃ©mico y Mental</h1>
    <p>PreparaciÃ³n de <strong>Fweek</strong> | IngenierÃ­a en InformÃ¡tica Militar</p>
  </header>

  <div class="container">
    <!-- ===== FISICO ===== -->
    <div class="card">
      <h2>ðŸ’ª Aspecto FÃ­sico</h2>
      <ul id="fisico"></ul>
      <button id="addFisico" class="btn ghost">âž• AÃ±adir tarea</button>
      <button id="resetFisico" class="btn">Reiniciar lista</button>

      <h3>Tracker de progreso</h3>
      <table>
        <tr><th>Prueba</th><th>Actual</th><th>Meta</th><th>%</th></tr>
        <tr><td>2.4 km</td><td><input id="km" type="number" value="13" style="width:70px"></td><td>9.75</td><td><span id="p-km">0%</span></td></tr>
        <tr><td>Lagartijas</td><td><input id="pu" type="number" value="25" style="width:70px"></td><td>55</td><td><span id="p-pu">0%</span></td></tr>
        <tr><td>Abdominales</td><td><input id="su" type="number" value="35" style="width:70px"></td><td>70</td><td><span id="p-su">0%</span></td></tr>
        <tr><td>Dominadas</td><td><input id="pl" type="number" value="2" style="width:70px"></td><td>10</td><td><span id="p-pl">0%</span></td></tr>
      </table>
      <div class="progress"><div id="bar-fisico" class="bar"></div></div>
      <button id="saveFisico" class="btn">Guardar Progreso</button>
      <canvas id="chartFisico"></canvas>
    </div>

    <!-- ===== ACADEMICO ===== -->
    <div class="card">
      <h2>ðŸ“˜ Aspecto AcadÃ©mico</h2>
      <ul id="academico"></ul>
      <button id="addAcademico" class="btn ghost">âž• AÃ±adir tema</button>
      <button id="clearAcademico" class="btn">Eliminar completadas</button>

      <h3>Horas de estudio (dÃ­a)</h3>
      <input id="horas" type="number" value="2" min="0" max="8" style="width:70px"> h
      <div class="progress"><div id="bar-academico" class="bar"></div></div>
      <button id="saveAcademico" class="btn">Guardar progreso acadÃ©mico</button>
      <canvas id="chartAcademico"></canvas>
    </div>

    <!-- ===== MENTAL ===== -->
    <div class="card">
      <h2>ðŸ§  Aspecto Mental y Disciplina</h2>
      <ul id="mental"></ul>
      <button id="addMental" class="btn ghost">âž• AÃ±adir hÃ¡bito</button>
      <button id="resetMental" class="btn">Reiniciar hÃ¡bitos</button>

      <h3>ReflexiÃ³n diaria</h3>
      <textarea id="notaMental" rows="3" placeholder="Â¿QuÃ© aprendiste o cÃ³mo te sentiste hoy?"></textarea>
      <button id="saveNotaMental" class="btn">Guardar reflexiÃ³n</button>
      <canvas id="chartMental"></canvas>
    </div>

    <footer>Â© 2025 Plan CMI | Desarrollado por Fweek ðŸª–</footer>
  </div>

  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <script>
  const db = new Dexie("PlanCMI_DB");
  db.version(1).stores({
    fisico:"++id,tarea,completado",
    academico:"++id,tarea,completado",
    mental:"++id,tarea,completado",
    progreso:"++id,tipo,valor,fecha",
    notas:"++id,fecha,texto"
  });

  const $=s=>document.querySelector(s);
  const hoy=new Date().toISOString().slice(0,10);

  async function renderList(tabla,el){
    const data=await db[tabla].toArray();
    el.innerHTML="";
    data.forEach(d=>{
      const li=document.createElement("li");
      li.innerHTML=`<input type="checkbox" ${d.completado?'checked':''}> <input type="text" value="${d.tarea}">`;
      li.querySelector("input[type=checkbox]").onchange=e=>db[tabla].update(d.id,{completado:e.target.checked});
      li.querySelector("input[type=text]").onchange=e=>db[tabla].update(d.id,{tarea:e.target.value});
      el.appendChild(li);
    });
  }

  const addTask=(t,texto)=>db[t].add({tarea:texto,completado:false});

  async function renderAll(){
    renderList("fisico",$("#fisico"));
    renderList("academico",$("#academico"));
    renderList("mental",$("#mental"));
  }
  renderAll();

  $("#addFisico").onclick=()=>addTask("fisico","Nueva tarea").then(renderAll);
  $("#resetFisico").onclick=()=>db.fisico.clear().then(renderAll);
  $("#addAcademico").onclick=()=>addTask("academico","Nuevo tema").then(renderAll);
  $("#clearAcademico").onclick=()=>db.academico.where("completado").equals(1).delete().then(renderAll);
  $("#addMental").onclick=()=>addTask("mental","Nuevo hÃ¡bito").then(renderAll);
  $("#resetMental").onclick=()=>db.mental.clear().then(renderAll);

  function pct(val,meta,inverse=false){if(inverse)return Math.max(0,Math.min(1,(15-val)/(15-9.75)));return Math.max(0,Math.min(1,val/meta));}
  function updateFisico(){
    const km=parseFloat($("#km").value)||13;
    const pu=+$("#pu").value||0;const su=+$("#su").value||0;const pl=+$("#pl").value||0;
    const pkm=pct(km,9.75,true),ppu=pct(pu,55),psu=pct(su,70),ppl=pct(pl,10);
    $("#p-km").textContent=Math.round(pkm*100)+"%";
    $("#p-pu").textContent=Math.round(ppu*100)+"%";
    $("#p-su").textContent=Math.round(psu*100)+"%";
    $("#p-pl").textContent=Math.round(ppl*100)+"%";
    $("#bar-fisico").style.width=Math.round((pkm+ppu+psu+ppl)/4*100)+"%";
  }
  ["km","pu","su","pl"].forEach(id=>$("#"+id).oninput=updateFisico);
  updateFisico();

  $("#saveFisico").onclick=async()=>{
    const valor={km:+$("#km").value,pu:+$("#pu").value,su:+$("#su").value,pl:+$("#pl").value};
    await db.progreso.add({tipo:"fisico",valor,fecha:hoy});
    renderCharts();
  };
  $("#saveAcademico").onclick=async()=>{
    const horas=+$("#horas").value||0;
    await db.progreso.add({tipo:"academico",valor:horas,fecha:hoy});
    $("#bar-academico").style.width=Math.min(100,horas/4*100)+"%";
    renderCharts();
  };
  $("#saveNotaMental").onclick=async()=>{
    await db.notas.add({fecha:hoy,texto:$("#notaMental").value});
    $("#notaMental").value="";renderCharts();
  };

  let chartFisico,chartAcademico,chartMental;
  async function renderCharts(){
    const datos=await db.progreso.toArray();
    const fechas=[...new Set(datos.map(d=>d.fecha))].sort();
    const fisico=fechas.map(f=>{
      const e=datos.filter(d=>d.fecha===f&&d.tipo==="fisico");
      if(!e.length)return 0;
      const v=e[e.length-1].valor;
      const avg=(pct(v.km,9.75,true)+pct(v.pu,55)+pct(v.su,70)+pct(v.pl,10))/4;
      return Math.round(avg*100);
    });
    const academico=fechas.map(f=>{
      const e=datos.filter(d=>d.fecha===f&&d.tipo==="academico");
      return e.length?Math.min(100,e[e.length-1].valor/4*100):0;
    });
    const mentalNotas=await db.notas.toArray();
    const mental=fechas.map(f=>mentalNotas.some(n=>n.fecha===f)?100:0);

    if(chartFisico)chartFisico.destroy();
    chartFisico=new Chart($("#chartFisico"),{
      type:"line",
      data:{labels:fechas,datasets:[{label:"Progreso fÃ­sico (%)",data:fisico,borderColor:"#b89f5d",backgroundColor:"rgba(184,159,93,.2)",tension:.3}]},
      options:{scales:{y:{beginAtZero:true,max:100}}}
    });
    if(chartAcademico)chartAcademico.destroy();
    chartAcademico=new Chart($("#chartAcademico"),{
      type:"bar",
      data:{labels:fechas,datasets:[{label:"Horas de estudio",data:academico,backgroundColor:"#8ba870"}]},
      options:{scales:{y:{beginAtZero:true,max:100}}}
    });
    if(chartMental)chartMental.destroy();
    chartMental=new Chart($("#chartMental"),{
      type:"line",
      data:{labels:fechas,datasets:[{label:"DÃ­as con reflexiÃ³n registrada",data:mental,borderColor:"#f2c94c",backgroundColor:"rgba(242,201,76,.2)",tension:.3}]},
      options:{scales:{y:{beginAtZero:true,max:100}}}
    });
  }
  renderCharts();
  if("serviceWorker" in navigator){navigator.serviceWorker.register("service-worker.js");}
  </script>
</body>
</html>
