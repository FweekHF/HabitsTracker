<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan CMI â€” Dashboard Completo</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg:#f8fafc;--fg:#0f172a;--muted:#475569;--card:#fff;
      --line:#e2e8f0;--brand:#0ea5e9;--brand2:#0369a1;
      --ok:#10b981;--warn:#f59e0b;--bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      background:var(--bg);color:var(--fg);line-height:1.55}
    header{background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;padding:24px;text-align:center;border-radius:0 0 16px 16px}
    h1{margin:0;font-size:clamp(1.5rem,2.2vw + .8rem,2.4rem)}
    .container{max-width:1100px;margin:auto;padding:16px}
    .card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:16px;
      border:1px solid var(--line);box-shadow:0 1px 3px rgba(2,6,23,.05),0 8px 24px rgba(2,6,23,.06)}
    .card h2{margin-top:0}
    .btn{background:var(--brand);border:none;border-radius:8px;color:#fff;
      padding:8px 12px;font-weight:600;cursor:pointer;margin:4px}
    .btn.ghost{background:#e2e8f0;color:#0f172a}
    .progress{height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:6px}
    .bar{height:100%;background:linear-gradient(90deg,#22c55e,#0ea5e9);width:0%}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #e2e8f0;text-align:left}
    th{background:#f1f5f9}
    canvas{width:100%!important;max-height:300px}
    .small{font-size:.9rem;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>Plan Integral CMI â€” Dashboard de Progreso</h1>
    <p>Candidato: <strong>Fweek</strong> | IngenierÃ­a en InformÃ¡tica Militar</p>
  </header>

  <div class="container">
    <!-- ===== FISICO ===== -->
    <div class="card">
      <h2>ðŸ’ª Aspecto FÃ­sico</h2>
      <ul id="fisico"></ul>
      <button id="addFisico" class="btn ghost">âž• AÃ±adir tarea</button>
      <button id="resetFisico" class="btn">Reiniciar lista</button>

      <h3>Tracker de progreso</h3>
      <table>
        <tr><th>Prueba</th><th>Actual</th><th>Meta</th><th>%</th></tr>
        <tr><td>2.4 km</td><td><input id="km" type="number" value="13" style="width:70px"></td><td>9.75</td><td><span id="p-km">0%</span></td></tr>
        <tr><td>Lagartijas</td><td><input id="pu" type="number" value="25" style="width:70px"></td><td>55</td><td><span id="p-pu">0%</span></td></tr>
        <tr><td>Abdominales</td><td><input id="su" type="number" value="35" style="width:70px"></td><td>70</td><td><span id="p-su">0%</span></td></tr>
        <tr><td>Dominadas</td><td><input id="pl" type="number" value="2" style="width:70px"></td><td>10</td><td><span id="p-pl">0%</span></td></tr>
      </table>
      <div class="progress"><div id="bar-fisico" class="bar"></div></div>
      <button id="saveFisico" class="btn">Guardar Progreso</button>
      <canvas id="chartFisico"></canvas>
    </div>

    <!-- ===== ACADEMICO ===== -->
    <div class="card">
      <h2>ðŸ“˜ Aspecto AcadÃ©mico</h2>
      <ul id="academico"></ul>
      <button id="addAcademico" class="btn ghost">âž• AÃ±adir tema</button>
      <button id="clearAcademico" class="btn">Eliminar completadas</button>

      <h3>Horas de estudio (dÃ­a)</h3>
      <input id="horas" type="number" value="2" min="0" max="8" style="width:70px"> h
      <div class="progress"><div id="bar-academico" class="bar"></div></div>
      <button id="saveAcademico" class="btn">Guardar progreso acadÃ©mico</button>
      <canvas id="chartAcademico"></canvas>
    </div>

    <!-- ===== MENTAL ===== -->
    <div class="card">
      <h2>ðŸ§  Aspecto Mental y Disciplina</h2>
      <ul id="mental"></ul>
      <button id="addMental" class="btn ghost">âž• AÃ±adir hÃ¡bito</button>
      <button id="resetMental" class="btn">Reiniciar hÃ¡bitos</button>

      <h3>ReflexiÃ³n diaria</h3>
      <textarea id="notaMental" rows="3" style="width:100%;border:1px solid #e2e8f0;border-radius:10px;padding:8px"></textarea>
      <button id="saveNotaMental" class="btn">Guardar reflexiÃ³n</button>
      <canvas id="chartMental"></canvas>
    </div>
  </div>

  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <script>
  const db = new Dexie("PlanCMI_DB");
  db.version(1).stores({
    fisico:"++id,tarea,completado",
    academico:"++id,tarea,completado",
    mental:"++id,tarea,completado",
    progreso:"++id,tipo,valor,fecha",
    notas:"++id,fecha,texto"
  });
  const $=s=>document.querySelector(s);
  const hoy=new Date().toISOString().slice(0,10);

  // Render genÃ©rico
  async function renderList(nombre,el){
    const data=await db[nombre].toArray();el.innerHTML="";
    data.forEach(d=>{
      const li=document.createElement("li");
      li.innerHTML=`<input type="checkbox" ${d.completado?'checked':''}> <input type="text" value="${d.tarea}">`;
      li.querySelector("input[type=checkbox]").onchange=e=>db[nombre].update(d.id,{completado:e.target.checked});
      li.querySelector("input[type=text]").onchange=e=>db[nombre].update(d.id,{tarea:e.target.value});
      el.appendChild(li);
    });
  }
  function addTask(tabla,texto){return db[tabla].add({tarea:texto,completado:false});}

  // FÃ­sico
  async function renderFisico(){renderList("fisico",$("#fisico"));}
  $("#addFisico").onclick=()=>addTask("fisico","Nueva tarea").then(renderFisico);
  $("#resetFisico").onclick=()=>db.fisico.clear().then(renderFisico);
  renderFisico();

  // AcadÃ©mico
  async function renderAcademico(){renderList("academico",$("#academico"));}
  $("#addAcademico").onclick=()=>addTask("academico","Nuevo tema").then(renderAcademico);
  $("#clearAcademico").onclick=()=>db.academico.where("completado").equals(1).delete().then(renderAcademico);
  renderAcademico();

  // Mental
  async function renderMental(){renderList("mental",$("#mental"));}
  $("#addMental").onclick=()=>addTask("mental","Nuevo hÃ¡bito").then(renderMental);
  $("#resetMental").onclick=()=>db.mental.clear().then(renderMental);
  renderMental();

  // Trackers
  function pct(val,meta,inverse=false){if(inverse)return Math.max(0,Math.min(1,(15-val)/(15-9.75)));return Math.max(0,Math.min(1,val/meta));}
  function updateFisico(){
    const km=parseFloat($("#km").value)||13;
    const pu=+$("#pu").value||0;const su=+$("#su").value||0;const pl=+$("#pl").value||0;
    const pkm=pct(km,9.75,true),ppu=pct(pu,55),psu=pct(su,70),ppl=pct(pl,10);
    $("#p-km").textContent=Math.round(pkm*100)+"%";
    $("#p-pu").textContent=Math.round(ppu*100)+"%";
    $("#p-su").textContent=Math.round(psu*100)+"%";
    $("#p-pl").textContent=Math.round(ppl*100)+"%";
    $("#bar-fisico").style.width=Math.round((pkm+ppu+psu+ppl)/4*100)+"%";
  }
  ["km","pu","su","pl"].forEach(id=>$("#"+id).oninput=updateFisico);
  updateFisico();

  $("#saveFisico").onclick=async()=>{
    const valor={km:+$("#km").value,pu:+$("#pu").value,su:+$("#su").value,pl:+$("#pl").value};
    await db.progreso.add({tipo:"fisico",valor,fecha:hoy});
    renderCharts();
  };
  $("#saveAcademico").onclick=async()=>{
    const horas=+$("#horas").value||0;
    await db.progreso.add({tipo:"academico",valor:horas,fecha:hoy});
    $("#bar-academico").style.width=Math.min(100,horas/4*100)+"%";
    renderCharts();
  };
  $("#saveNotaMental").onclick=async()=>{
    await db.notas.add({fecha:hoy,texto:$("#notaMental").value});
    $("#notaMental").value="";renderCharts();
  };

  // === DASHBOARD CHARTS ===
  let chartFisico,chartAcademico,chartMental;
  async function renderCharts(){
    const datos=await db.progreso.toArray();
    const fechas=[...new Set(datos.map(d=>d.fecha))].sort();
    const fisico=fechas.map(f=>{
      const e=datos.filter(d=>d.fecha===f&&d.tipo==="fisico");
      if(!e.length)return 0;
      const v=e[e.length-1].valor;
      const avg=(pct(v.km,9.75,true)+pct(v.pu,55)+pct(v.su,70)+pct(v.pl,10))/4;
      return Math.round(avg*100);
    });
    const academico=fechas.map(f=>{
      const e=datos.filter(d=>d.fecha===f&&d.tipo==="academico");
      return e.length?Math.min(100,e[e.length-1].valor/4*100):0;
    });
    const mentalNotas=await db.notas.toArray();
    const mental=fechas.map(f=>mentalNotas.some(n=>n.fecha===f)?100:0);

    if(chartFisico)chartFisico.destroy();
    chartFisico=new Chart($("#chartFisico"),{
      type:"line",
      data:{labels:fechas,datasets:[{label:"Progreso fÃ­sico (%)",data:fisico,borderColor:"#0ea5e9",tension:.3}]},
      options:{scales:{y:{beginAtZero:true,max:100}}}
    });
    if(chartAcademico)chartAcademico.destroy();
    chartAcademico=new Chart($("#chartAcademico"),{
      type:"bar",
      data:{labels:fechas,datasets:[{label:"Horas de estudio",data:academico,backgroundColor:"#10b981"}]},
      options:{scales:{y:{beginAtZero:true,max:100}}}
    });
    if(chartMental)chartMental.destroy();
    chartMental=new Chart($("#chartMental"),{
      type:"line",
      data:{labels:fechas,datasets:[{label:"DÃ­as con reflexiÃ³n registrada",data:mental,borderColor:"#f59e0b"}]},
      options:{scales:{y:{beginAtZero:true,max:100}}}
    });
  }
  renderCharts();

  if("serviceWorker" in navigator){navigator.serviceWorker.register("service-worker.js");}
  </script>
</body>
</html>

